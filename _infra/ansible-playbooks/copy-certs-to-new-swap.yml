---

- name: Copy certs to home directory on old swap
  hosts: legacy_puzzle_massive_old_swap
  user: dev
  become: true
  tasks:

    - name: Copy fullchain.pem to /home/dev
      ansible.builtin.copy:
        remote_src: yes
        src: /etc/letsencrypt/live/puzzle.massive.xyz/fullchain.pem
        dest: /home/dev/temporary_fullchain.pem
        owner: dev
        group: dev

    - name: Copy privkey.pem to /home/dev
      ansible.builtin.copy:
        remote_src: yes
        src: /etc/letsencrypt/live/puzzle.massive.xyz/privkey.pem
        dest: /home/dev/temporary_privkey.pem

- name: Synchronize old swap certs to new swap
  hosts: legacy_puzzle_massive_new_swap
  user: dev
  become: true
  tasks:

    - name: Synchronize temporary_fullchain.pem
      ansible.posix.synchronize:
        mode: pull
        src: "rsync://{{ old_swap }}/home/dev/temporary_fullchain.pem"
        dest: /etc/nginx/
      delegate_to: "{{ inventory_hostname }}"

    - name: Synchronize temporary_privkey.pem
      ansible.posix.synchronize:
        mode: pull
        src: "rsync://{{ old_swap }}/home/dev/temporary_privkey.pem"
        dest: /etc/nginx/
      delegate_to: "{{ inventory_hostname }}"

    - name: Touch the .has-certs file
      ansible.builtin.file:
        path: /usr/local/src/puzzle-massive/.has-certs
        state: touch
    - name: Touch the web/snippets/ssl_certificate-ssl_certificate_key.nginx.conf.sh file
      ansible.builtin.file:
        path: /usr/local/src/puzzle-massive/web/snippets/ssl_certificate-ssl_certificate_key.nginx.conf.sh
        state: touch

    - name: "Make"
      shell: "source bin/activate && make ENVIRONMENT=production"
      args:
        executable: /usr/bin/bash
        chdir: /usr/local/src/puzzle-massive/
    - name: "Make install"
      shell: "source bin/activate && make install ENVIRONMENT=production"
      args:
        executable: /usr/bin/bash
        chdir: /usr/local/src/puzzle-massive/
    - name: "NGINX configuration test"
      command: "nginx -t"
    - name: Reload NGINX
      ansible.builtin.systemd:
        state: reloaded
        daemon_reload: yes
        name: nginx
